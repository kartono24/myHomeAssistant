#!/usr/bin/env python3
import socket
import requests
from subprocess import Popen, PIPE
import json

## line which as Node004 ZRC-90 command
# scene1
#2017-02-11 09:19:47.158 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xef, 0x00, 0x01, 0x47
# scene2
#2017-02-11 09:19:48.552 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf0, 0x00, 0x02, 0x5b
# scene3
#2017-02-11 09:19:50.080 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf1, 0x00, 0x03, 0x5b
# scene4
#2017-02-11 09:19:51.272 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf2, 0x00, 0x04, 0x5f
# scene5
#2017-02-11 09:19:52.285 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf3, 0x00, 0x05, 0x5f
# scene6
#2017-02-11 09:19:53.230 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf4, 0x00, 0x06, 0x5b
# scene7
#2017-02-11 09:19:54.175 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf5, 0x00, 0x07, 0x5b
# scene8
#2017-02-11 09:19:55.008 Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03, 0xf6, 0x00, 0x08, 0x57

# match rule
MATCHER = 'Detail, Node004,   Received: 0x01, 0x0b, 0x00, 0x04, 0x00, 0x04, 0x05, 0x5b, 0x03,'


OZW_LOG = '/home/homeassistant/.homeassistant/OZW_Log.txt'



# HA information
URI = 'http://192.168.1.8:8123/api/services/script/turn_on'
TOKEN = 'YourPassword'

debug = True

log = Popen(('/usr/bin/tail', '-F', '-n', '0', OZW_LOG), stdout=PIPE)
while True:
    line = log.stdout.readline()
    if not line:
        break

    line = line.strip().decode('utf-8')

    # Fast match to discard non-info log messages
    if MATCHER not in line:
        continue

    button = line.split(',')[-2].replace(' 0x0','')
    event = 'script.zrc90_a_button_{0}'.format(button)
    if debug:
        print(event)

    if event:
        data = {'entity_id': event}
        if debug:
            print(data)
        resp = requests.post(URI, data=json.dumps(data), headers={'x-ha-access': TOKEN, 'content-type': 'application/json'})
